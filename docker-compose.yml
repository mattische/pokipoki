services:
  poker-planning: 
    image: mattische/pokipoki:latest  # image from Docker Hub
    # build: .   # uncomment if building locally instead
    pull_policy: always  # always fetch latest version
    container_name:  pokipoki
    expose: 
      - "${PORT:-3000}"  # port from .env, must match Caddyfile
    environment: 
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=${PORT:-3000}  # port from .env (default 3000)
      - JWT_SECRET=${JWT_SECRET}
    restart: unless-stopped
    networks: 
      - pokipoki-network

  caddy: 
    image:  caddy:2-alpine
    container_name: pokipoki-caddy
    restart: unless-stopped
    ports: 
      - "80:80"  # default http port
      - "443:443"  # default https port
      - "443:443/udp"  # secure http3 proxying
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile
      - caddy_data:/data
      - caddy_config:/config
    environment: 
      - DOMAIN=${DOMAIN:-pokerplanning. duckdns.org}
      - PORT=${PORT:-3000}  # pass PORT to Caddy for reverse proxy
    networks:
      - pokipoki-network
    depends_on:
      - poker-planning

  # Development service with volume mapping
  poker-planning-dev: 
    build: .  # builds locally for development
    container_name: pokipoki-dev
    ports:
      - "3001:${PORT:-3000}"  # expose dev server on port 3001
    environment:
      - NODE_ENV=development
      - PORT=${PORT:-3000}
      - JWT_SECRET=${JWT_SECRET}
    volumes:
      - ./src:/app/src
      - ./public:/app/public
      - ./server.js:/app/server.js
    restart: unless-stopped
    profiles: 
      - dev

networks:  
  pokipoki-network:  
    driver: bridge

volumes:  
  caddy_data: 
  caddy_config: 